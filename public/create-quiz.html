<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Quiz - QuizMaster</title>
    <link rel="stylesheet" href="/css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
</head>
<body>
<nav class="navbar">
    <div class="navbar-container">
        <a href="/" class="navbar-brand">üéØ QuizMaster</a>
        <div class="navbar-menu">
            <a href="/" class="navbar-link">Home</a>
            <a href="/dashboard.html" class="navbar-link">Dashboard</a>
            <div class="navbar-user">
                <div class="user-avatar" id="userAvatar">üéÆ</div>
                <span id="userName"></span>
            </div>
        </div>
    </div>
</nav>

<div class="container">
    <div style="max-width: 800px; margin: 40px auto;">
        <h1 class="text-center mb-4">üìù Create Your Quiz</h1>

        <div id="alertMessage" class="hidden"></div>

        <div class="card mb-4">
            <div class="card-header">
                <h2 class="card-title">Quiz Information</h2>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label class="form-label">Quiz Title *</label>
                    <input type="text" class="form-control" id="quizTitle" placeholder="e.g., World Geography Challenge" maxlength="100" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-control" id="quizDescription" placeholder="Tell players what this quiz is about..." maxlength="500"></textarea>
                </div>

                <div class="grid grid-3">
                    <div class="form-group">
                        <label class="form-label">Category *</label>
                        <select class="form-control" id="quizCategory" required>
                            <option value="General">General</option>
                            <option value="Science">Science</option>
                            <option value="History">History</option>
                            <option value="Math">Math</option>
                            <option value="Geography">Geography</option>
                            <option value="Entertainment">Entertainment</option>
                            <option value="Sports">Sports</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Difficulty *</label>
                        <select class="form-control" id="quizDifficulty" required>
                            <option value="Easy">Easy</option>
                            <option value="Medium">Medium</option>
                            <option value="Hard">Hard</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Cover Emoji</label>
                        <select class="form-control" id="quizCoverImage">
                            <option value="üìö">üìö Book</option>
                            <option value="üß†">üß† Brain</option>
                            <option value="üåç">üåç Globe</option>
                            <option value="üî¨">üî¨ Science</option>
                            <option value="üé®">üé® Art</option>
                            <option value="‚öΩ">‚öΩ Sports</option>
                            <option value="üéÆ">üéÆ Gaming</option>
                            <option value="üé¨">üé¨ Movies</option>
                            <option value="üéµ">üéµ Music</option>
                            <option value="üí°">üí° Light Bulb</option>
                        </select>
                    </div>
                </div>

                <button class="btn btn-primary btn-block" onclick="createQuizInfo()">
                    Continue to Questions ‚Üí
                </button>
            </div>
        </div>

        <div id="questionsSection" class="hidden">
            <div class="card mb-4">
                <div class="card-header">
                    <h2 class="card-title">Add Questions</h2>
                    <span class="badge badge-primary" id="questionCount">0 Questions</span>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label class="form-label">Question Text *</label>
                        <input type="text" class="form-control" id="questionText" placeholder="e.g., What is the capital of France?">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Question Type</label>
                        <select class="form-control" id="questionType" onchange="updateOptionsCount()">
                            <option value="multiple-choice">Multiple Choice (4 options)</option>
                            <option value="true-false">True / False</option>
                        </select>
                    </div>

                    <div id="optionsContainer">

                    </div>

                    <div class="grid grid-2">
                        <div class="form-group">
                            <label class="form-label">Time Limit (seconds)</label>
                            <input type="number" class="form-control" id="questionTimeLimit" value="20" min="5" max="120">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Points</label>
                            <input type="number" class="form-control" id="questionPoints" value="100" min="50" max="1000" step="50">
                        </div>
                    </div>

                    <button class="btn btn-success btn-block" onclick="addQuestion()">
                        ‚ûï Add Question
                    </button>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header">
                    <h2 class="card-title">Questions List</h2>
                </div>
                <div class="card-body">
                    <div id="questionsList"></div>
                    <div id="questionsEmpty" class="empty-state">
                        <div class="empty-state-icon">‚ùì</div>
                        <h3 class="empty-state-title">No Questions Added Yet</h3>
                        <p class="empty-state-text">Add at least one question to publish your quiz</p>
                    </div>
                </div>
            </div>

            <button class="btn btn-primary btn-lg btn-block" onclick="publishQuiz()" id="publishBtn" disabled>
                üöÄ Publish Quiz
            </button>
        </div>
    </div>
</div>

<script>
    const API_URL = 'https://quizland-xyy3.onrender.com/api';
    let currentQuizId = null;
    let questions = [];

    async function checkAuth() {
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '/auth.html';
            return;
        }

        try {
            const response = await fetch(`${API_URL}/auth/profile`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            const result = await response.json();

            if (response.ok && result.success && result.data && result.data.user) {
                document.getElementById('userName').textContent = result.data.user.username;
                document.getElementById('userAvatar').textContent = result.data.user.avatar;

            } else {
                console.error('Auth failed:', result.message);
                localStorage.removeItem('token');
                window.location.href = '/auth.html';
            }
        } catch (error) {
            console.error('Auth error:', error);
            window.location.href = '/auth.html';
        }
    }

    async function createQuizInfo() {
        const title = document.getElementById('quizTitle').value.trim();
        const description = document.getElementById('quizDescription').value.trim();
        const category = document.getElementById('quizCategory').value;
        const difficulty = document.getElementById('quizDifficulty').value;
        const coverImage = document.getElementById('quizCoverImage').value;

        if (!title) {
            showAlert('‚ùå Please enter a quiz title', 'error');
            return;
        }

        try {
            const token = localStorage.getItem('token');
            const response = await fetch(`${API_URL}/quizzes`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    title,
                    description,
                    category,
                    difficulty,
                    coverImage
                })
            });

            const data = await response.json();

            if (data.success) {
                currentQuizId = data.quiz._id;
                showAlert('‚úÖ Quiz created! Now add questions.', 'success');

                document.getElementById('questionsSection').classList.remove('hidden');

                document.querySelectorAll('#quizTitle, #quizDescription, #quizCategory, #quizDifficulty, #quizCoverImage').forEach(input => {
                    input.disabled = true;
                });

                updateOptionsCount();
            } else {
                showAlert('‚ùå ' + data.message, 'error');
            }
        } catch (error) {
            console.error('Create quiz error:', error);
            showAlert('‚ùå Failed to create quiz', 'error');
        }
    }

    function updateOptionsCount() {
        const type = document.getElementById('questionType').value;
        const container = document.getElementById('optionsContainer');

        if (type === 'true-false') {
            container.innerHTML = `
                    <div class="form-group">
                        <label class="form-label">Correct Answer *</label>
                        <div class="grid grid-2">
                            <label class="option-btn">
                                <input type="radio" name="correctAnswer" value="0" checked>
                                <span class="option-letter">‚úì</span>
                                <span>True</span>
                            </label>
                            <label class="option-btn">
                                <input type="radio" name="correctAnswer" value="1">
                                <span class="option-letter">‚úó</span>
                                <span>False</span>
                            </label>
                        </div>
                    </div>
                `;
        } else {
            container.innerHTML = `
                    <div class="form-group">
                        <label class="form-label">Options (select the correct one) *</label>
                        ${[0, 1, 2, 3].map(i => `
                            <div class="flex" style="gap: 12px; margin-bottom: 12px;">
                                <input type="radio" name="correctAnswer" value="${i}" ${i === 0 ? 'checked' : ''}>
                                <input type="text" class="form-control" id="option${i}" placeholder="Option ${String.fromCharCode(65 + i)}" required>
                            </div>
                        `).join('')}
                    </div>
                `;
        }
    }

    async function addQuestion() {
        const questionText = document.getElementById('questionText').value.trim();
        const questionType = document.getElementById('questionType').value;
        const timeLimit = parseInt(document.getElementById('questionTimeLimit').value);
        const points = parseInt(document.getElementById('questionPoints').value);

        if (!questionText) {
            showAlert('‚ùå Please enter a question text', 'error');
            return;
        }

        let options = [];

        if (questionType === 'true-false') {
            const correctAnswer = parseInt(document.querySelector('input[name="correctAnswer"]:checked').value);
            options = [
                { text: 'True', isCorrect: correctAnswer === 0 },
                { text: 'False', isCorrect: correctAnswer === 1 }
            ];
        } else {
            const correctAnswerIndex = parseInt(document.querySelector('input[name="correctAnswer"]:checked').value);

            for (let i = 0; i < 4; i++) {
                const optionText = document.getElementById(`option${i}`).value.trim();
                if (!optionText) {
                    showAlert(`‚ùå Please fill in all options`, 'error');
                    return;
                }
                options.push({
                    text: optionText,
                    isCorrect: i === correctAnswerIndex
                });
            }
        }

        try {
            const token = localStorage.getItem('token');
            const response = await fetch(`${API_URL}/quizzes/${currentQuizId}/questions`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    questionText,
                    questionType,
                    options,
                    timeLimit,
                    points
                })
            });

            const data = await response.json();

            if (data.success) {
                questions.push(data.question);
                showAlert('‚úÖ Question added!', 'success');

                document.getElementById('questionText').value = '';
                if (questionType === 'multiple-choice') {
                    for (let i = 0; i < 4; i++) {
                        document.getElementById(`option${i}`).value = '';
                    }
                }

                updateQuestionsList();
            } else {
                showAlert('‚ùå ' + data.message, 'error');
            }
        } catch (error) {
            console.error('Add question error:', error);
            showAlert('‚ùå Failed to add question', 'error');
        }
    }

    function updateQuestionsList() {
        const container = document.getElementById('questionsList');
        const emptyState = document.getElementById('questionsEmpty');
        const publishBtn = document.getElementById('publishBtn');

        document.getElementById('questionCount').textContent = `${questions.length} Questions`;

        if (questions.length === 0) {
            container.innerHTML = '';
            emptyState.style.display = 'block';
            publishBtn.disabled = true;
            return;
        }

        emptyState.style.display = 'none';
        publishBtn.disabled = false;

        container.innerHTML = questions.map((q, index) => `
                <div class="card mb-2">
                    <div class="card-body">
                        <div class="flex-between">
                            <div style="flex: 1;">
                                <strong>Q${index + 1}:</strong> ${q.questionText}
                                <div class="quiz-meta mt-1">
                                    <span class="badge badge-primary">${q.questionType}</span>
                                    <span class="quiz-meta-item">‚è±Ô∏è ${q.timeLimit}s</span>
                                    <span class="quiz-meta-item">‚≠ê ${q.points} pts</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
    }

    function publishQuiz() {
        if (questions.length === 0) {
            showAlert('‚ùå Add at least one question before publishing', 'error');
            return;
        }

        showAlert('‚úÖ Quiz published successfully!', 'success');

        setTimeout(() => {
            window.location.href = '/dashboard.html';
        }, 1500);
    }

    function showAlert(message, type) {
        const alert = document.getElementById('alertMessage');
        alert.className = `alert alert-${type}`;
        alert.textContent = message;
        alert.classList.remove('hidden');

        setTimeout(() => {
            alert.classList.add('hidden');
        }, 5000);
    }

    window.addEventListener('load', () => {
        checkAuth();
    });

    document.addEventListener('change', (e) => {
        if (e.target.name === 'correctAnswer') {
            document.querySelectorAll('label.option-btn').forEach(label => {
                label.classList.remove('selected');
            });
            e.target.closest('label')?.classList.add('selected');
        }
    });
</script>
</body>
</html>