<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ë–ª–æ–≥ –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .user-info {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f0f9ff;
            border-radius: 8px;
        }
        .btn-logout {
            background: #dc2626;
            margin-left: 10px;
        }
        .btn-logout:hover {
            background: #b91c1c;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>üìù –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ë–ª–æ–≥–∞–º–∏</h1>

    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ -->
    <div id="userInfo" class="user-info" style="display: none;">
        <p>üë§ –í—ã –≤–æ—à–ª–∏ –∫–∞–∫: <strong id="userName"></strong></p>
        <button class="btn-logout" onclick="handleLogout()">–í—ã–π—Ç–∏</button>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (–µ—Å–ª–∏ –Ω–µ –∑–∞–ª–æ–≥–∏–Ω–µ–Ω) -->
    <div id="authPrompt" style="text-align: center; margin-bottom: 20px;">
        <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, <a href="/auth.html" style="color: #4f46e5; font-weight: 600;">–≤–æ–π–¥–∏—Ç–µ</a> –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Å—Ç–æ–≤</p>
    </div>

    <div class="card" id="createPostCard" style="display: none;">
        <h3>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø–æ—Å—Ç</h3>
        <input type="text" id="title" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫">
        <textarea id="body" placeholder="–¢–µ–∫—Å—Ç –ø–æ—Å—Ç–∞"></textarea>
        <button class="btn-main" onclick="createPost()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
    </div>

    <div style="text-align: center; margin: 20px;">
        <button class="btn-load" onclick="loadPosts()">üì• –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –±–ª–æ–≥–∏</button>
    </div>

    <div id="posts"></div>
</div>

<script>
    const API = '/blogs';
    let currentUser = null;

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    async function checkAuth() {
        try {
            const res = await fetch('/api/auth/check');
            const data = await res.json();

            if (data.isAuthenticated) {
                currentUser = data.user;
                document.getElementById('userInfo').style.display = 'block';
                document.getElementById('userName').textContent = data.user.name;
                document.getElementById('authPrompt').style.display = 'none';
                document.getElementById('createPostCard').style.display = 'block';
            } else {
                document.getElementById('userInfo').style.display = 'none';
                document.getElementById('authPrompt').style.display = 'block';
                document.getElementById('createPostCard').style.display = 'none';
            }
        } catch (error) {
            console.error('Auth check error:', error);
        }
    }

    async function handleLogout() {
        try {
            const res = await fetch('/api/auth/logout', { method: 'POST' });
            const data = await res.json();

            if (data.success) {
                alert('–í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã');
                window.location.reload();
            }
        } catch (error) {
            console.error('Logout error:', error);
        }
    }

    async function loadPosts() {
        const res = await fetch(API);
        const data = await res.json();
        const container = document.getElementById('posts');

        container.innerHTML = data.map(p => `
            <div class="blog-post card">
                <h3>${p.title}</h3>
                <p>${p.body}</p>
                <small>–ê–≤—Ç–æ—Ä: ${p.author}</small>
                ${currentUser ? `
                <div class="actions">
                    <button class="btn-edit" onclick="editPost('${p._id}', '${p.title}', '${p.body}')">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                    <button class="btn-delete" onclick="deletePost('${p._id}')">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                </div>
                ` : ''}
            </div>
        `).join('');
    }

    async function createPost() {
        const title = document.getElementById('title').value;
        const body = document.getElementById('body').value;

        if (!title || !body) {
            alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!');
            return;
        }

        await fetch(API, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                title,
                body,
                author: currentUser ? currentUser.name : 'Anonymous'
            })
        });

        document.getElementById('title').value = '';
        document.getElementById('body').value = '';
        alert("–ü–æ—Å—Ç —Å–æ–∑–¥–∞–Ω!");
        loadPosts();
    }

    async function editPost(id, oldTitle, oldBody) {
        const newTitle = prompt("–ù–æ–≤—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫:", oldTitle);
        const newBody = prompt("–ù–æ–≤—ã–π —Ç–µ–∫—Å—Ç:", oldBody);

        if (newTitle && newBody) {
            await fetch(`${API}/${id}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ title: newTitle, body: newBody })
            });
            loadPosts();
        }
    }

    async function deletePost(id) {
        if (confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø–æ—Å—Ç?")) {
            await fetch(`${API}/${id}`, { method: 'DELETE' });
            loadPosts();
        }
    }

    window.addEventListener('load', () => {
        checkAuth();
        loadPosts();
    });
</script>
</body>
</html>