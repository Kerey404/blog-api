<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - QuizMaster</title>
    <link rel="stylesheet" href="/css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
</head>
<body>
<nav class="navbar">
    <div class="navbar-container">
        <a href="/" class="navbar-brand">üéØ QuizMaster</a>
        <div class="navbar-menu">
            <a href="/" class="navbar-link">Home</a>
            <a href="/dashboard.html" class="navbar-link">Dashboard</a>
            <div class="navbar-user">
                <div class="user-avatar" id="userAvatar">üéÆ</div>
                <span id="userName"></span>
                <button class="btn btn-sm btn-danger" onclick="logout()">Logout</button>
            </div>
        </div>
    </div>
</nav>

<div class="container">
    <div class="hero-section mb-4">
        <h1 class="hero-title" id="welcomeMessage">Welcome back!</h1>
        <p class="hero-subtitle">Manage your quizzes and track your progress</p>
        <a href="/create-quiz.html" class="btn btn-primary btn-lg">‚ûï Create New Quiz</a>
    </div>

    <div class="stats-container mb-4">
        <div class="stat-card">
            <div class="stat-icon">üìö</div>
            <div class="stat-value" id="quizzesCreatedCount">0</div>
            <div class="stat-label">Quizzes Created</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">üéÆ</div>
            <div class="stat-value" id="quizzesPlayedCount">0</div>
            <div class="stat-label">Quizzes Played</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">‚≠ê</div>
            <div class="stat-value" id="totalPlaysCount">0</div>
            <div class="stat-label">Total Plays on Your Quizzes</div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">
            <h2 class="card-title">üìù My Quizzes</h2>
            <a href="/create-quiz.html" class="btn btn-primary btn-sm">‚ûï New Quiz</a>
        </div>
        <div class="card-body">
            <div id="myQuizzesLoading" class="loading-container">
                <div class="loader"></div>
                <p class="loading-text">Loading your quizzes...</p>
            </div>
            <div id="myQuizzesGrid" class="grid grid-2"></div>
            <div id="myQuizzesEmpty" class="empty-state hidden">
                <div class="empty-state-icon">üìù</div>
                <h3 class="empty-state-title">No Quizzes Yet</h3>
                <p class="empty-state-text">Create your first quiz to get started!</p>
                <a href="/create-quiz.html" class="btn btn-primary">Create Quiz</a>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h2 class="card-title">üèÜ Recent Plays</h2>
        </div>
        <div class="card-body">
            <div id="recentPlaysContainer"></div>
            <div id="recentPlaysEmpty" class="empty-state hidden">
                <div class="empty-state-icon">üéÆ</div>
                <h3 class="empty-state-title">No Games Played Yet</h3>
                <p class="empty-state-text">Start playing quizzes to see your history here!</p>
                <a href="/not-public/publicblic/public" class="btn btn-primary">Browse Quizzes</a>
            </div>
        </div>
    </div>
</div>

<script>
    const API_URL = 'https://quizland-xyy3.onrender.com/api';
    let currentUser = null;
    let myQuizzes = [];

    async function checkAuth() {
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '/auth.html';
            return;
        }

        try {
            const response = await fetch(`${API_URL}/auth/profile`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            const result = await response.json();

            if (response.ok && result.success) {
                currentUser = result.data.user;

                document.getElementById('userName').textContent = currentUser.username;
                document.getElementById('userAvatar').textContent = currentUser.avatar;
                document.getElementById('welcomeMessage').textContent = `Welcome back, ${currentUser.username}! üëã`;

                updateStats();
                loadMyQuizzes();
                loadRecentPlays();
            } else {
                localStorage.removeItem('token');
                window.location.href = '/auth.html';
            }
        } catch (error) {
            console.error('Auth error:', error);
            window.location.href = '/auth.html';
        }
    }

    function updateStats() {
        if (!currentUser) return;

        const createdCount = currentUser.quizzesCreated ? currentUser.quizzesCreated.length : 0;
        document.getElementById('quizzesCreatedCount').textContent = createdCount;

        const playedCount = currentUser.quizzesPlayed ? currentUser.quizzesPlayed.length : 0;
        document.getElementById('quizzesPlayedCount').textContent = playedCount;

        const totalPlays = myQuizzes.reduce((sum, quiz) => sum + (quiz.timesPlayed || 0), 0);
        document.getElementById('totalPlaysCount').textContent = totalPlays;
    }
    async function loadMyQuizzes() {
        try {
            const token = localStorage.getItem('token');
            const response = await fetch(`${API_URL}/quizzes/my/created`, { // –£–±–µ–¥–∏—Å—å, —á—Ç–æ —Ä–æ—É—Ç –≤–µ—Ä–Ω—ã–π
                headers: { 'Authorization': `Bearer ${token}` }
            });

            const result = await response.json();

            if (result.success) {
                myQuizzes = result.quizzes;

                if (myQuizzes.length === 0) {
                    document.getElementById('myQuizzesLoading').style.display = 'none';
                    document.getElementById('myQuizzesEmpty').classList.remove('hidden');
                } else {
                    displayMyQuizzes();
                }
                updateStats();
            }
        } catch (error) {
            console.error('Error loading quizzes:', error);
            document.getElementById('myQuizzesLoading').innerHTML = '<p class="text-danger">Failed to load</p>';
        }
    }


    function displayMyQuizzes() {
        const grid = document.getElementById('myQuizzesGrid');
        document.getElementById('myQuizzesLoading').style.display = 'none';

        grid.innerHTML = myQuizzes.map(quiz => `
                <div class="quiz-card">
                    <div class="quiz-card-header">
                        <div class="quiz-card-icon">${quiz.coverImage}</div>
                    </div>
                    <div class="quiz-card-body">
                        <h3 class="quiz-card-title">${quiz.title}</h3>
                        <p class="quiz-card-description">${quiz.description || 'No description'}</p>

                        <div class="quiz-meta">
                            <span class="badge badge-primary">${quiz.category}</span>
                            <span class="badge ${getDifficultyBadgeClass(quiz.difficulty)}">${quiz.difficulty}</span>
                        </div>

                        <div class="quiz-meta">
                            <span class="quiz-meta-item">üìù ${quiz.questions.length} Questions</span>
                            <span class="quiz-meta-item">üéÆ ${quiz.timesPlayed} Plays</span>
                            <span class="quiz-meta-item">‚≠ê ${quiz.averageScore} Avg Score</span>
                        </div>

                        <div class="btn-group mt-3">
                            <button class="btn btn-primary btn-sm" onclick="editQuiz('${quiz._id}')">‚úèÔ∏è Edit</button>
                            <button class="btn btn-success btn-sm" onclick="playQuiz('${quiz._id}')">‚ñ∂Ô∏è Play</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteQuiz('${quiz._id}', '${quiz.title}')">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                </div>
            `).join('');
    }


    function loadRecentPlays() {
        const container = document.getElementById('recentPlaysContainer');

        const recentPlays = (currentUser.quizzesPlayed || []).slice(-5).reverse();

        if (recentPlays.length === 0) {
            document.getElementById('recentPlaysEmpty').classList.remove('hidden');
            document.getElementById('recentPlaysContainer').innerHTML = ''; // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
            return;
        }

        document.getElementById('recentPlaysEmpty').classList.add('hidden');

        container.innerHTML = recentPlays.map(play => {
            const date = new Date(play.playedAt).toLocaleDateString();

            const quizTitle = play.quiz ? play.quiz.title : 'Unknown Quiz';

            return `
                <div class="card mb-2">
                    <div class="flex-between">
                        <div>
                            <strong>${quizTitle}</strong>
                            <br>
                            <small class="text-muted">Played on ${date}</small>
                        </div>
                        <div class="text-center">
                            <div class="stat-value" style="font-size: 1.5rem;">${play.score}</div>
                            <div class="text-muted">Points</div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }


    function editQuiz(quizId) {
        window.location.href = `/create-quiz.html?edit=${quizId}`;
    }

    function playQuiz(quizId) {
        window.location.href = `/play-quiz.html?id=${quizId}`;
    }

    async function deleteQuiz(quizId, quizTitle) {
        if (!confirm(`Are you sure you want to delete "${quizTitle}"? This action cannot be undone.`)) {
            return;
        }

        try {
            const token = localStorage.getItem('token');
            const response = await fetch(`${API_URL}/quizzes/${quizId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            const data = await response.json();

            if (data.success) {
                alert('‚úÖ Quiz deleted successfully!');
                window.location.reload();
            } else {
                alert('‚ùå ' + data.message);
            }
        } catch (error) {
            console.error('Delete error:', error);
            alert('‚ùå Failed to delete quiz');
        }
    }

    function getDifficultyBadgeClass(difficulty) {
        switch(difficulty) {
            case 'Easy': return 'badge-success';
            case 'Medium': return 'badge-warning';
            case 'Hard': return 'badge-danger';
            default: return 'badge-primary';
        }
    }

    function logout() {
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        window.location.href = '/';
    }

    window.addEventListener('load', checkAuth);
</script>
</body>
</html>